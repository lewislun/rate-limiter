{"version":3,"file":"index.js","sources":["../src/rate-limiter.js"],"sourcesContent":["import * as types from './types.js'\n\nexport default class RateLimiter {\n\n\t/** @type {Map<string, RateLimiter>} */\t\tstatic instanceMap = new Map()\n\n\t/** @type {string} */\t\t\t\t\t\tinstanceKey\n\t/** @type {types.RateLimitedJob[]} */\t\tqueue = []\n\t/** @type {number} */\t\t\t\t\t\tcallIntervalMs = 200\n\t/** @type {number} */\t\t\t\t\t\tretryCount = 4\n\t/** @type {number} */\t\t\t\t\t\tonErrPauseTimeMs = 500\n\t/** @type {number} */\t\t\t\t\t\ttimeoutMs = 10000\n\t/** @type {(msg) => void} */\t\t\t\tlog\n\t/** @protected @type {NodeJS.Timeout} */\tnextIteration\n\n\t/**\n\t * Get an initialized RateLimiter by opts.instanceKey. If it does not exist, create one. This is useful for sharing RateLimiter if the same endpoint is used.\n\t * \n\t * @static\n\t * @public\n\t * @param {types.RateLimiterOpts} [opts={}]\n\t * @returns {RateLimiter}\n\t */\n\tstatic getInstance(opts = {}) {\n\t\t// create a new one if instanceKey is not set\n\t\tconst instanceKey = opts?.instanceKey\n\t\tif (!instanceKey) {\n\t\t\treturn new RateLimiter(opts)\n\t\t}\n\n\t\tconst instance = this.instanceMap.get(instanceKey)\n\t\tif (instance) {\n\t\t\treturn instance\n\t\t}\n\n\t\tconst newInstance = new RateLimiter(opts)\n\t\tthis.instanceMap.set(instanceKey, newInstance)\n\t\treturn newInstance\n\t}\n\n\t/**\n\t * @param {RateLimiterOpts} [opts]\n\t */\n\tconstructor(opts = {}) {\n\t\tthis.instanceKey = opts.instanceKey\n\t\tthis.retryCount = opts.retryCount ?? this.retryCount\n\t\tthis.onErrPauseTimeMs = opts.onErrPauseTimeMs ?? this.onErrPauseTimeMs\n\t\tthis.log = opts.log ?? (() => {})\n\t\tif (opts.callPerSec) {\n\t\t\tthis.callIntervalMs = 1000 / opts.callPerSec\n\t\t}\n\n\t\tif (this.callIntervalMs) {\n\t\t\tthis.start()\n\t\t}\n\t}\n\n\t/**\n\t * @returns {boolean}\n\t */\n\tget isLoopRunning() {\n\t\treturn !!this.nextIteration\n\t}\n\n\t/**\n\t * @public\n\t */\n\tstart() {\n\t\tif (!this.callIntervalMs) {\n\t\t\tthrow new Error('Cannot start jobLoop with callIntervalMs === 0 or undefined.')\n\t\t}\n\t\tif (this.isLoopRunning) {\n\t\t\tthis.log('jobLoop is already running.')\n\t\t\treturn\n\t\t}\n\n\t\tthis.loop()\n\t}\n\n\t/**\n\t * @protected\n\t */\n\tasync loop() {\n\t\tif (this.queue.length === 0) {\n\t\t\tthis.nextIteration = setTimeout(() => this.loop(), 100)\n\t\t\treturn\n\t\t}\n\t\tthis.processJob(this.queue.shift())\n\t\tthis.nextIteration = setTimeout(() => this.loop(), this.callIntervalMs)\n\t}\n\n\t/**\n\t * Stop the jobLoop. No-op if the loop is not running.\n\t * \n\t * @public\n\t */\n\tstop() {\n\t\tif (this.isLoopRunning) {\n\t\t\tclearTimeout(this.nextIteration)\n\t\t\tthis.nextIteration = undefined\n\t\t}\n\t}\n\n\t/**\n\t * @public\n\t * @param {number} pauseTimeMs\n\t */\n\tpause(pauseTimeMs) {\n\t\tthis.stop()\n\t\tthis.nextIteration = setTimeout(() => this.start(), pauseTimeMs)\n\t}\n\n\t/**\n\t * @protected\n\t * @param {RateLimitedJob} job\n\t */\n\tasync processJob(job) {\n\t\ttry {\n\t\t\tconst result = await Promise.race([\n\t\t\t\tjob.func(),\n\t\t\t\tnew Promise((_, reject) => setTimeout(() => reject(new Error('RateLimitJob timed out.')), this.timeoutMs))\n\t\t\t])\n\t\t\tjob.callback(result)\n\t\t} catch (e) {\n\t\t\tif (job.retryCount >= this.retryCount) {\n\t\t\t\tthis.log(`RateLimitJob execution failed with exception: ${e}, rejecting this job... (instanceKey: ${this.instanceKey}, retryCount: ${job.retryCount})`)\n\t\t\t\tjob.errCallback(e)\n\t\t\t\treturn\n\t\t\t}\n\t\t\tconst retryCount = job.retryCount ?? 0\n\t\t\tconst pauseTimeMs = this.onErrPauseTimeMs * Math.pow(2, retryCount)\n\t\t\tthis.log(`RateLimitJob execution failed with exception: ${e}, pushing it back to queue to retry... (instanceKey: ${this.instanceKey}, retryCount: ${retryCount}, pauseTimeMs: ${pauseTimeMs}, queueLength: ${this.queue.length})`)\n\t\t\tjob.retryCount = retryCount + 1\n\t\t\tthis.queue.push(job)\n\t\t\tif (this.isLoopRunning) {\n\t\t\t\tthis.pause(pauseTimeMs)\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Accepts both sync and async functions.\n\t * \n\t * @public\n\t * @template T\n\t * @param {() => Promise<T>} func\n\t * @param {string} name\n\t * @returns {Promise<T>}\n\t */\n\tasync exec(func, name = undefined) {\n\t\tif (this.callIntervalMs) {\n\t\t\tlet callback, errCallback\n\t\t\t/** @type {Promise<T>} */\n\t\t\tlet promise = new Promise((resolve, reject) => {\n\t\t\t\tcallback = resolve\n\t\t\t\terrCallback = reject\n\t\t\t})\n\t\t\tthis.queue.push({ func, callback, errCallback, name })\n\t\t\treturn await promise\n\n\t\t// ignore queue if callIntervalMs is undefined or 0 (i.e. not rate limited)\n\t\t} else {\n\t\t\treturn await func()\n\t\t}\n\t}\n}"],"names":[],"mappings":"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"}